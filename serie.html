<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PipocaFlix ‚Äî Assistir S√©rie</title>
<meta name="theme-color" content="#ff2d43">
<link rel="stylesheet" href="../assets/css/style.css">
<script src="https://pl28456424.effectivegatecpm.com/af/b2/ae/afb2aeef36a1a40f4d3634823ebf0f59.js"></script>
</head>
<body>

<!-- Mobile search -->
<div class="mobile-search-overlay" id="mobileSearchOverlay" role="dialog">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;color:var(--red)">
    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
  </svg>
  <input type="search" class="mobile-search-input" id="mobileSearchInput"
    placeholder="Buscar..." autocomplete="off" spellcheck="false">
  <button class="mobile-search-cancel" id="mobileSearchClose">Cancelar</button>
</div>

<!-- Header -->
<header class="header" id="mainHeader">
  <a href="index.html" class="logo">PipocaFlix</a>
  <nav class="nav">
    <a href="index.html">In√≠cio</a>
    <a href="catalogo.html">Cat√°logo</a>
    <a href="catalogo.html?tipo=filmes">Filmes</a>
    <a href="catalogo.html?tipo=series">S√©ries</a>
  </nav>
  <div class="search-wrapper">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
    <input type="search" class="search-bar" id="desktopSearchInput" placeholder="Buscar..." autocomplete="off" spellcheck="false">
  </div>
  <button class="search-toggle-btn" id="mobileSearchToggle" aria-label="Abrir busca" aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
  </button>
</header>

<!-- Search results -->
<div class="search-results-overlay" id="searchResultsOverlay">
  <p class="search-results-label">Resultados para: <strong id="searchQueryLabel"></strong></p>
  <div class="cards-grid" id="searchResultsGrid"></div>
</div>

<!-- Detail Hero -->
<section class="detail-hero" id="detailHero">
  <div class="detail-bg" id="detailBg"></div>
  <div class="detail-content">
    <img id="detailPoster" class="detail-poster"
      src="https://placehold.co/300x450/13131a/333?text=..."
      alt="Capa">
    <div class="detail-info">
      <div id="loadingMsg" style="color:var(--text-3);font-size:1rem">‚è≥ Carregando...</div>
      <h1 class="detail-title" id="detailTitle" style="display:none"></h1>
      <div class="detail-tags" id="detailTags" style="display:none"></div>
      <div class="detail-meta-row" id="detailMeta" style="display:none"></div>
      <p class="detail-synopsis" id="detailSynopsis" style="display:none"></p>
      <div class="hero-btns" id="detailBtns" style="display:none">
        <button class="btn-primary" id="scrollToEpsBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          Ver Epis√≥dios
        </button>
        <a href="index.html" class="btn-secondary">‚Üê Voltar</a>
      </div>
    </div>
  </div>
</section>

<!-- Ad -->
<div class="ad-section">
  <div class="ad-wrap ad-468x60">
    <script>
      atOptions = { 'key':'c7b645a0a4ac7dc79a9417f5852ebe16','format':'iframe','height':60,'width':468,'params':{} };
    </script>
    <script src="https://www.highperformanceformat.com/c7b645a0a4ac7dc79a9417f5852ebe16/invoke.js"></script>
  </div>
</div>

<!-- Player -->
<section class="player-section" id="playerSection" style="display:none">
  <p class="player-section-title" id="playerSectionTitle">üé¨ Player</p>

  <div class="player-container" id="playerBox" style="display:none">
    <video id="video" preload="metadata"></video>
    <div class="player-overlay" id="playerOverlay">
      <img src="https://i.ibb.co/6Jbf2TRY/transferir-1.jpg" class="player-overlay-logo" alt="PipocaFlix"
        onerror="this.style.display='none'">
      <span class="player-overlay-text">Selecione um epis√≥dio abaixo</span>
    </div>
    <button class="center-play-btn" id="centerPlay" aria-label="Reproduzir">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>
    <div class="player-controls hidden" id="playerControls">
      <div class="player-ctrl-row">
        <button class="ctrl-btn" id="back10" aria-label="‚àí10s">
          <svg viewBox="0 0 24 24"><path d="M11 18V6l-8 6 8 6zm2-12h8v2h-8zm0 6h6v2h-6z"/></svg>
        </button>
        <button class="ctrl-btn" id="playPause" aria-label="Play/Pause">‚ñ∂</button>
        <button class="ctrl-btn" id="forward10" aria-label="+10s">
          <svg viewBox="0 0 24 24"><path d="M13 6v12l8-6-8-6zm-2 12H3v-2h8zm0-6H5v-2h6z"/></svg>
        </button>
        <div class="player-title" id="playerTitle">PipocaFlix</div>
        <button class="ctrl-btn" id="fullscreenBtn" aria-label="Tela cheia">
          <svg viewBox="0 0 24 24"><path d="M4 4h6v2H6v4H4V4zm14 0v6h-2V6h-4V4h6zm0 14h-6v-2h4v-4h2v6zm-14 0v-6h2v4h4v2H4z"/></svg>
        </button>
      </div>
      <div class="player-progress-row">
        <span class="player-time" id="currentTime">0:00</span>
        <div class="player-progress" id="progressBar">
          <div class="player-progress-filled" id="progressFilled"></div>
        </div>
        <span class="player-time" id="totalTime">0:00</span>
      </div>
    </div>
  </div>
</section>

<!-- Native Banner -->
<div class="ad-section">
  <script async data-cfasync="false"
    src="https://pl28456427.effectivegatecpm.com/cccc7245f0c46289c4b3a2911da39bca/invoke.js"></script>
  <div id="container-cccc7245f0c46289c4b3a2911da39bca"></div>
</div>

<!-- Trailer -->
<section class="trailer-section" id="trailerSection" style="display:none">
  <div class="section-header" style="padding:0;margin-bottom:1rem">
    <h2 class="section-title">Trailer Oficial</h2>
  </div>
  <div class="trailer-wrap">
    <iframe id="trailerFrame" title="Trailer" allowfullscreen loading="lazy"
      allow="autoplay; encrypted-media; picture-in-picture"></iframe>
  </div>
</section>

<!-- Elenco -->
<section class="cast-section" id="castSection" style="display:none">
  <div class="section-header" style="padding:0;margin-bottom:1rem">
    <h2 class="section-title">Elenco</h2>
  </div>
  <div class="cast-scroll" id="castScroll"></div>
</section>

<!-- Temporadas & Epis√≥dios -->
<section class="seasons-section" id="seasonsSection" style="display:none">
  <div class="section-header" style="padding:0;margin-bottom:1.25rem">
    <h2 class="section-title">Temporadas &amp; Epis√≥dios</h2>
  </div>
  <div class="season-tabs" id="seasonTabs" role="tablist"></div>
  <div class="episodes-list" id="episodesList" role="list"></div>
  <p id="noEpsMsg" style="display:none;color:var(--text-3);padding:1rem 0">
    ‚ÑπÔ∏è Epis√≥dios ainda n√£o cadastrados para esta s√©rie.
  </p>
</section>

<!-- 300x250 -->
<div class="ad-section">
  <div class="ad-wrap ad-300x250">
    <script>
      atOptions = { 'key':'cc3696d612a9f3e92f49193e4b3418e6','format':'iframe','height':250,'width':300,'params':{} };
    </script>
    <script src="https://www.highperformanceformat.com/cc3696d612a9f3e92f49193e4b3418e6/invoke.js"></script>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <div class="footer-logo">PipocaFlix</div>
  <p class="footer-desc">O melhor cat√°logo de filmes e s√©ries online.</p>
  <div class="footer-bottom">
    <span>¬© 2025 PipocaFlix.</span>
    <a href="index.html" style="color:var(--red)">‚Üê Voltar ao in√≠cio</a>
  </div>
</footer>

<button class="back-to-top" id="backToTop" aria-label="Voltar ao topo">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>
</button>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script src="../assets/js/security.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/search.js"></script>
<script src="../assets/js/player.js"></script>
<script>
let seriePlayer = null;
let temporadaAtual = 1;
let temporadasData = {};
let nomeSerie = '';

window.addEventListener('scroll', () => {
  document.getElementById('mainHeader').classList.toggle('scrolled', window.scrollY > 60);
  document.getElementById('backToTop').classList.toggle('visible', window.scrollY > 400);
}, {passive:true});
document.getElementById('backToTop').addEventListener('click', () => window.scrollTo({top:0,behavior:'smooth'}));

document.getElementById('mobileSearchToggle').addEventListener('click', () => {
  document.getElementById('mobileSearchOverlay').classList.add('open');
  setTimeout(() => document.getElementById('mobileSearchInput').focus(), 80);
});
document.getElementById('mobileSearchClose').addEventListener('click', () => {
  document.getElementById('mobileSearchOverlay').classList.remove('open');
  document.getElementById('searchResultsOverlay').classList.remove('active');
  document.getElementById('mobileSearchInput').value='';
});
document.addEventListener('keydown', e => {
  if (e.key==='Escape') {
    document.getElementById('mobileSearchOverlay').classList.remove('open');
    document.getElementById('searchResultsOverlay').classList.remove('active');
    document.getElementById('desktopSearchInput').value='';
    document.getElementById('mobileSearchInput').value='';
  }
});

function getParam(k) { return new URLSearchParams(location.search).get(k); }
function ytEmbed(url) {
  if (!url) return '';
  const m=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?]+)/);
  return m ? `https://www.youtube.com/embed/${m[1]}?rel=0` : '';
}

function renderCast(nomes, fotos) {
  if (!nomes) return;
  const ns=nomes.split(',').map(s=>s.trim()).filter(Boolean);
  const fs=fotos?fotos.split(',').map(s=>s.trim()):[];
  const wrap=document.getElementById('castScroll');
  ns.forEach((n,i)=>{
    const foto=fs[i]||`https://placehold.co/84x84/1a1a24/555?text=${encodeURIComponent(n[0]||'?')}`;
    const div=document.createElement('div');
    div.className='cast-item';
    div.innerHTML=`<img class="cast-avatar" src="${foto}" alt="${n}"
      onerror="this.src='https://placehold.co/84x84/1a1a24/555?text=${encodeURIComponent(n[0]||'?')}'">
      <div class="cast-name">${n}</div>`;
    wrap.appendChild(div);
  });
  document.getElementById('castSection').style.display='block';
}

function renderTemporadas() {
  const tabs = document.getElementById('seasonTabs');
  const nums = Object.keys(temporadasData).map(Number).sort((a,b)=>a-b);
  if (nums.length===0) { document.getElementById('noEpsMsg').style.display='block'; return; }

  tabs.innerHTML='';
  nums.forEach(t=>{
    const btn=document.createElement('button');
    btn.className='season-tab'+(t===temporadaAtual?' active':'');
    btn.textContent=`Temporada ${t}`;
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', t===temporadaAtual?'true':'false');
    btn.addEventListener('click',()=>{
      temporadaAtual=t;
      tabs.querySelectorAll('.season-tab').forEach(b=>{b.classList.remove('active');b.setAttribute('aria-selected','false');});
      btn.classList.add('active');
      btn.setAttribute('aria-selected','true');
      renderEpisodios();
    });
    tabs.appendChild(btn);
  });
  renderEpisodios();
}

function renderEpisodios() {
  const lista=document.getElementById('episodesList');
  const eps=temporadasData[temporadaAtual]||[];
  lista.innerHTML='';
  if (eps.length===0) {
    lista.innerHTML='<p style="color:var(--text-3);padding:1rem 0">Sem epis√≥dios para esta temporada.</p>';
    return;
  }
  eps.forEach(ep=>{
    const btn=document.createElement('button');
    btn.className='episode-btn';
    btn.setAttribute('role','listitem');
    btn.innerHTML=`
      <span class="ep-num">${String(ep.episodio).padStart(2,'0')}</span>
      <span class="ep-name">${nomeSerie} ‚Äî T${ep.temporada} EP${ep.episodio}</span>
      <span class="ep-play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></span>`;
    btn.addEventListener('click',()=>tocar(ep));
    lista.appendChild(btn);
  });
}

function tocar(ep) {
  PipocaAPI.openSmartlink();
  const titulo=`${nomeSerie} ‚Äî T${ep.temporada} EP${ep.episodio}`;
  if (seriePlayer) seriePlayer.loadEpisode(ep.linkMP4, titulo);
}

function setupSearch(allItems) {
  PipocaSearch.indexContent(allItems);
  const overlay=document.getElementById('searchResultsOverlay');
  const grid=document.getElementById('searchResultsGrid');
  const label=document.getElementById('searchQueryLabel');
  function mkCard(item) {
    const d=document.createElement('div'); d.className='card';
    const page=item.isSerie?'serie.html':'filme.html';
    d.innerHTML=`<div class="card-thumb-wrap">
      <img class="card-thumb" src="${item.capa||''}" alt="${item.nome}" loading="lazy"
        onerror="this.src='https://placehold.co/300x450/13131a/333?text=Sem+Capa'">
      <span class="card-badge">${item.isSerie?'S√©rie':'Filme'}</span>
      <div class="card-play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
    </div>
    <div class="card-info"><div class="card-name">${item.nome}</div>
    <div class="card-meta-row"><span>${item.ano||''}</span></div></div>`;
    d.addEventListener('click',()=>location.href=`${page}?nome=${encodeURIComponent(item.nome)}`);
    return d;
  }
  function doSearch(q) {
    if (!q||q.length<2) { overlay.classList.remove('active'); return; }
    const res=PipocaSearch.search(q,30);
    label.textContent=q; grid.innerHTML='';
    res.forEach(i=>grid.appendChild(mkCard(i)));
    overlay.classList.add('active');
  }
  const deb=PipocaSearch.debounce(doSearch,250);
  document.getElementById('desktopSearchInput').addEventListener('input',e=>deb(e.target.value));
  document.getElementById('mobileSearchInput').addEventListener('input',e=>deb(e.target.value));
}

async function init() {
  const nomeParam = getParam('nome');
  if (!nomeParam) { location.href='index.html'; return; }
  nomeSerie = nomeParam;
  document.title = `${nomeSerie} ‚Äî PipocaFlix`;

  try {
    const [series, allContent] = await Promise.all([
      PipocaAPI.getSeries(),
      PipocaAPI.getTodosConteudos()
    ]);
    setupSearch(allContent);

    const normNome = PipocaAPI.normalizeStr(nomeParam);
    const item = series.find(s=>PipocaAPI.normalizeStr(s.nome)===normNome)
              || series.find(s=>PipocaAPI.normalizeStr(s.nome).includes(normNome)||normNome.includes(PipocaAPI.normalizeStr(s.nome)));

    if (!item) { document.getElementById('loadingMsg').textContent='‚ö†Ô∏è S√©rie n√£o encontrada.'; return; }
    nomeSerie = item.nome;

    // BG + Poster
    document.getElementById('detailBg').style.backgroundImage=`url(${item.capa||''})`;
    const poster=document.getElementById('detailPoster');
    poster.src=item.capa||'https://placehold.co/300x450/13131a/333?text=Sem+Capa';
    poster.alt=item.nome;

    // Info
    document.getElementById('loadingMsg').style.display='none';
    document.getElementById('detailTitle').textContent=item.nome;
    document.getElementById('detailTitle').style.display='';

    const tags=document.getElementById('detailTags');
    if (item.categoria) item.categoria.split(',').forEach(c=>{if(!c.trim())return;const s=document.createElement('span');s.className='tag';s.textContent=c.trim();tags.appendChild(s);});
    if (item.audio) {const s=document.createElement('span');s.className='tag';s.textContent='üîä '+item.audio;tags.appendChild(s);}
    const sTag=document.createElement('span');sTag.className='tag';sTag.textContent=`üì∫ ${item.totalTemp||'?'} Temporada(s)`;tags.appendChild(sTag);
    tags.style.display='flex';

    document.getElementById('detailMeta').innerHTML=[
      item.ano?`<span><strong>üìÖ</strong> ${item.ano}</span>`:'',
      item.duracao?`<span><strong>‚è±</strong> ${item.duracao}</span>`:'',
      item.tipo?`<span><strong>üì∫</strong> ${item.tipo}</span>`:'',
    ].join('');
    document.getElementById('detailMeta').style.display='flex';
    document.getElementById('detailSynopsis').textContent=item.sinopse||'Sinopse n√£o dispon√≠vel.';
    document.getElementById('detailSynopsis').style.display='';
    document.getElementById('detailBtns').style.display='flex';

    document.getElementById('scrollToEpsBtn').addEventListener('click',()=>
      document.getElementById('seasonsSection').scrollIntoView({behavior:'smooth'}));

    // Trailer
    const ytUrl=ytEmbed(item.trailer);
    if (ytUrl) { document.getElementById('trailerFrame').src=ytUrl; document.getElementById('trailerSection').style.display='block'; }

    // Cast
    renderCast(item.nomeElenco, item.fotoElenco);

    // Player init
    document.getElementById('playerSection').style.display='block';
    document.getElementById('playerTitle').textContent=item.nome;

    seriePlayer = PipocaPlayer.initSeriePlayer({
      videoId:'video', overlayId:'playerOverlay', centerPlayId:'centerPlay',
      controlsId:'playerControls', playerBoxId:'playerBox', titleId:'playerTitle'
    });

    // Epis√≥dios
    temporadasData = await PipocaAPI.getEpisodiosPorSerie(item.nome);
    const nums = Object.keys(temporadasData).map(Number);
    temporadaAtual = nums.length > 0 ? Math.min(...nums) : 1;

    document.getElementById('seasonsSection').style.display='block';
    renderTemporadas();

  } catch(err) {
    console.error('[PipocaFlix S√©rie]',err);
    document.getElementById('loadingMsg').textContent='‚ö†Ô∏è Erro ao carregar a s√©rie.';
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
