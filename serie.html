<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PipocaFlix ‚Äî Assistir S√©rie</title>
<meta name="description" content="Assista s√©ries online gr√°tis no PipocaFlix em HD.">
<meta name="theme-color" content="#e50914">
<link rel="stylesheet" href="../assets/css/style.css">
<script src="https://pl28456424.effectivegatecpm.com/af/b2/ae/afb2aeef36a1a40f4d3634823ebf0f59.js"></script>
</head>
<body>

<!-- Mobile search overlay -->
<div class="mobile-search-overlay" id="mobileSearchOverlay" role="dialog">
  <svg style="flex-shrink:0;color:var(--red)" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
  </svg>
  <input type="search" class="mobile-search-input" id="mobileSearchInput"
    placeholder="Buscar filmes, s√©ries..." autocomplete="off" spellcheck="false">
  <button class="mobile-search-close" id="mobileSearchClose">Cancelar</button>
</div>

<!-- Header -->
<header class="header" id="mainHeader">
  <a href="index.html" class="logo">PIPOCA<span>FLIX</span></a>
  <nav class="nav">
    <a href="index.html">In√≠cio</a>
    <a href="index.html#filmes">Filmes</a>
    <a href="index.html#series">S√©ries</a>
  </nav>
  <div class="search-wrapper">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
    <input type="search" class="search-bar" id="desktopSearchInput"
      placeholder="Buscar..." autocomplete="off" spellcheck="false">
  </div>
  <button class="search-toggle-btn" id="mobileSearchToggle" aria-label="Abrir busca" aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
  </button>
</header>

<!-- Search results -->
<div class="search-results-overlay" id="searchResultsOverlay">
  <p class="search-results-title">Resultados para: <span id="searchQueryLabel"></span></p>
  <div class="cards-grid" id="searchResultsGrid"></div>
</div>

<!-- Detail Hero -->
<section class="detail-hero" id="detailHero">
  <div class="detail-bg" id="detailBg"></div>
  <div class="detail-content">
    <img id="detailPoster" class="detail-poster"
      src="https://placehold.co/300x450/181818/555?text=Carregando..."
      alt="Capa da s√©rie">
    <div class="detail-info">
      <div id="loadingIndicator" style="color:var(--text-muted);font-size:1rem;">‚è≥ Carregando...</div>
      <h1 class="detail-title" id="detailTitle" style="display:none"></h1>
      <div class="detail-tags" id="detailTags" style="display:none"></div>
      <div class="detail-meta-row" id="detailMeta" style="display:none"></div>
      <p class="detail-synopsis" id="detailSynopsis" style="display:none"></p>
      <div class="hero-buttons" id="detailButtons" style="display:none">
        <button class="btn-primary" id="watchNowBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          Ver Epis√≥dios
        </button>
        <a href="index.html" class="btn-secondary">‚Üê Voltar</a>
      </div>
    </div>
  </div>
</section>

<!-- Ad -->
<div class="ad-before-player">
  <script async data-cfasync="false"
    src="https://pl28456427.effectivegatecpm.com/cccc7245f0c46289c4b3a2911da39bca/invoke.js"></script>
  <div id="container-cccc7245f0c46289c4b3a2911da39bca"></div>
</div>

<!-- Player Section -->
<section class="player-section" id="playerSection" style="display:none">
  <h2 id="playerSectionTitle" style="font-family:var(--font-display);font-size:1.5rem;letter-spacing:1px;margin-bottom:1rem;text-align:center">üé¨ Player</h2>

  <div class="player-container" id="playerBox" style="display:none">
    <video id="video" preload="metadata"></video>

    <div class="player-overlay" id="playerOverlay">
      <img src="https://i.ibb.co/6Jbf2TRY/transferir-1.jpg" class="player-overlay-logo" alt="PipocaFlix"
        onerror="this.style.display='none'">
      <span class="player-overlay-text">Clique para reproduzir</span>
    </div>

    <button class="center-play-btn" id="centerPlay" aria-label="Reproduzir">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>

    <div class="player-controls hidden" id="playerControls">
      <div class="player-controls-row">
        <button class="ctrl-btn" id="back10" aria-label="Voltar 10s" title="‚àí10s">
          <svg viewBox="0 0 24 24"><path d="M11 18V6l-8 6 8 6zm2-12h8v2h-8zm0 6h6v2h-6z"/></svg>
        </button>
        <button class="ctrl-btn" id="playPause" aria-label="Play/Pause">&#9654;</button>
        <button class="ctrl-btn" id="forward10" aria-label="Avan√ßar 10s" title="+10s">
          <svg viewBox="0 0 24 24"><path d="M13 6v12l8-6-8-6zm-2 12H3v-2h8zm0-6H5v-2h6z"/></svg>
        </button>
        <div class="player-title" id="playerTitle">PipocaFlix</div>
        <button class="ctrl-btn" id="fullscreenBtn" aria-label="Tela cheia">
          <svg viewBox="0 0 24 24"><path d="M4 4h6v2H6v4H4V4zm14 0v6h-2V6h-4V4h6zm0 14h-6v-2h4v-4h2v6zm-14 0v-6h2v4h4v2H4z"/></svg>
        </button>
      </div>
      <div class="player-progress-row">
        <span class="player-time" id="currentTime">0:00</span>
        <div class="player-progress" id="progressBar">
          <div class="player-progress-filled" id="progressFilled"></div>
        </div>
        <span class="player-time" id="totalTime">0:00</span>
      </div>
    </div>
  </div>
</section>

<!-- Trailer -->
<section class="trailer-section" id="trailerSection" style="display:none">
  <div class="section-header" style="padding:0;margin-bottom:1rem">
    <h2 class="section-title">Trailer Oficial</h2>
  </div>
  <div class="trailer-container">
    <iframe id="trailerFrame" title="Trailer" allowfullscreen loading="lazy"
      allow="autoplay; encrypted-media; picture-in-picture"></iframe>
  </div>
</section>

<!-- Cast -->
<section class="cast-section" id="castSection" style="display:none">
  <div class="section-header" style="padding:0;margin-bottom:1rem">
    <h2 class="section-title">Elenco</h2>
  </div>
  <div class="cast-scroll" id="castScroll"></div>
</section>

<!-- Seasons & Episodes -->
<section class="seasons-section" id="seasonsSection" style="display:none">
  <h2 class="seasons-title">üì¶ Temporadas &amp; Epis√≥dios</h2>
  <div class="season-tabs" id="seasonTabs" role="tablist"></div>
  <div class="episodes-list" id="episodesList" role="list"></div>
  <p id="noEpisodesMsg" style="display:none;color:var(--text-muted);padding:1rem 0">
    ‚ÑπÔ∏è Epis√≥dios n√£o cadastrados no banco de dados desta s√©rie.
  </p>
</section>

<!-- Footer -->
<footer class="footer">
  <div class="footer-logo">PIPOCA<span>FLIX</span></div>
  <p class="footer-text">O melhor cat√°logo de filmes e s√©ries online.</p>
  <div class="ad-footer">
    <script async data-cfasync="false"
      src="https://pl28456427.effectivegatecpm.com/cccc7245f0c46289c4b3a2911da39bca/invoke.js"></script>
    <div id="container-cccc7245f0c46289c4b3a2911da39bca-footer"></div>
  </div>
  <div class="footer-bottom">
    <span>¬© 2025 PipocaFlix. Todos os direitos reservados.</span>
    <a href="index.html" style="color:var(--red)">‚Üê Voltar ao in√≠cio</a>
  </div>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script src="../assets/js/security.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/search.js"></script>
<script src="../assets/js/player.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   PIPOCAFLIX ‚Äî serie.js (inline)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let seriePlayer = null;
let temporadaAtual = 1;
let temporadasData = {};

window.addEventListener('scroll', () => {
  document.getElementById('mainHeader').classList.toggle('scrolled', window.scrollY > 50);
}, { passive: true });

/* ‚îÄ‚îÄ Mobile search ‚îÄ‚îÄ */
document.getElementById('mobileSearchToggle').addEventListener('click', () => {
  document.getElementById('mobileSearchOverlay').classList.add('open');
  setTimeout(() => document.getElementById('mobileSearchInput').focus(), 100);
});
document.getElementById('mobileSearchClose').addEventListener('click', () => {
  document.getElementById('mobileSearchOverlay').classList.remove('open');
  document.getElementById('searchResultsOverlay').classList.remove('active');
  document.getElementById('mobileSearchInput').value = '';
});

function getParam(key) {
  return new URLSearchParams(window.location.search).get(key);
}

function getYoutubeEmbedUrl(url) {
  if (!url) return '';
  const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?]+)/);
  if (m) return `https://www.youtube.com/embed/${m[1]}?rel=0`;
  return '';
}

function renderCast(nomeElenco, fotoElenco) {
  if (!nomeElenco) return;
  const nomes  = nomeElenco.split(',').map(s => s.trim()).filter(Boolean);
  const fotos  = fotoElenco ? fotoElenco.split(',').map(s => s.trim()) : [];
  const scroll = document.getElementById('castScroll');
  nomes.forEach((nome, i) => {
    const div = document.createElement('div');
    div.className = 'cast-item';
    const foto = fotos[i] || `https://placehold.co/90x90/181818/555?text=${encodeURIComponent(nome.charAt(0))}`;
    div.innerHTML = `
      <img class="cast-avatar" src="${foto}" alt="${nome}"
        onerror="this.src='https://placehold.co/90x90/181818/555?text=${encodeURIComponent(nome.charAt(0))}'">
      <div class="cast-name">${nome}</div>`;
    scroll.appendChild(div);
  });
  document.getElementById('castSection').style.display = 'block';
}

/* ‚îÄ‚îÄ Render temporadas ‚îÄ‚îÄ */
function renderTemporadas(nomeSerie) {
  const tabs  = document.getElementById('seasonTabs');
  const lista = document.getElementById('episodesList');
  const nEps  = document.getElementById('noEpisodesMsg');
  const numTemporadas = Object.keys(temporadasData).length;

  if (numTemporadas === 0) {
    nEps.style.display = 'block';
    return;
  }
  nEps.style.display = 'none';

  // Cria tabs de temporadas
  tabs.innerHTML = '';
  Object.keys(temporadasData).sort((a,b) => a-b).forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'season-tab' + (parseInt(t) === temporadaAtual ? ' active' : '');
    btn.textContent = `Temporada ${t}`;
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', parseInt(t) === temporadaAtual ? 'true' : 'false');
    btn.addEventListener('click', () => {
      temporadaAtual = parseInt(t);
      tabs.querySelectorAll('.season-tab').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      renderEpisodios(nomeSerie);
    });
    tabs.appendChild(btn);
  });

  renderEpisodios(nomeSerie);
}

/* ‚îÄ‚îÄ Render epis√≥dios ‚îÄ‚îÄ */
function renderEpisodios(nomeSerie) {
  const lista   = document.getElementById('episodesList');
  const eps     = temporadasData[temporadaAtual] || [];
  lista.innerHTML = '';

  if (eps.length === 0) {
    lista.innerHTML = '<p style="color:var(--text-muted);padding:1rem 0">Sem epis√≥dios para esta temporada.</p>';
    return;
  }

  eps.forEach(ep => {
    const btn = document.createElement('button');
    btn.className = 'episode-btn';
    btn.setAttribute('role', 'listitem');
    btn.innerHTML = `
      <span class="episode-num">${String(ep.episodio).padStart(2,'0')}</span>
      <span class="episode-name">${nomeSerie} ‚Äî T${temporadaAtual} EP${ep.episodio}</span>
      <span class="episode-play-icon">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </span>`;
    btn.addEventListener('click', () => tocar(ep, nomeSerie));
    lista.appendChild(btn);
  });
}

/* ‚îÄ‚îÄ Tocar epis√≥dio ‚îÄ‚îÄ */
function tocar(ep, nomeSerie) {
  PipocaAPI.openSmartlink();
  const titulo = `${nomeSerie} ‚Äî T${ep.temporada} EP${ep.episodio}`;
  if (seriePlayer) {
    seriePlayer.loadEpisode(ep.linkMP4, titulo);
  }
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
async function init() {
  const nome = getParam('nome');
  if (!nome) { location.href = 'index.html'; return; }

  document.title = `${nome} ‚Äî PipocaFlix`;

  try {
    const [series, allContent] = await Promise.all([
      PipocaAPI.getSeries(),
      PipocaAPI.getTodosConteudos()
    ]);

    PipocaSearch.indexContent(allContent);
    setupSearch(allContent);

    const item = series.find(s =>
      PipocaAPI.normalizeStr(s.nome) === PipocaAPI.normalizeStr(nome)
    ) || series.find(s =>
      PipocaAPI.normalizeStr(s.nome).includes(PipocaAPI.normalizeStr(nome)) ||
      PipocaAPI.normalizeStr(nome).includes(PipocaAPI.normalizeStr(s.nome))
    );

    if (!item) {
      document.getElementById('loadingIndicator').textContent = '‚ö†Ô∏è S√©rie n√£o encontrada.';
      return;
    }

    // Fundo e poster
    document.getElementById('detailBg').style.backgroundImage = `url(${item.capa || ''})`;
    const poster = document.getElementById('detailPoster');
    poster.src = item.capa || 'https://placehold.co/300x450/181818/555?text=Sem+Capa';
    poster.alt = item.nome;

    // Info
    document.getElementById('loadingIndicator').style.display = 'none';
    document.getElementById('detailTitle').textContent = item.nome;
    document.getElementById('detailTitle').style.display = '';

    const tagsEl = document.getElementById('detailTags');
    if (item.categoria) {
      item.categoria.split(',').forEach(cat => {
        const span = document.createElement('span');
        span.className = 'tag'; span.textContent = cat.trim();
        tagsEl.appendChild(span);
      });
    }
    if (item.audio) {
      const span = document.createElement('span');
      span.className = 'tag'; span.textContent = 'üîä ' + item.audio;
      tagsEl.appendChild(span);
    }
    const serieTag = document.createElement('span');
    serieTag.className = 'tag';
    serieTag.textContent = `üì∫ ${item.totalTemp || '?'} Temporada(s)`;
    tagsEl.appendChild(serieTag);
    tagsEl.style.display = 'flex';

    document.getElementById('detailMeta').innerHTML = `
      ${item.ano     ? `<span><strong>üìÖ</strong> ${item.ano}</span>`       : ''}
      ${item.duracao ? `<span><strong>‚è±</strong> ${item.duracao}</span>`    : ''}
      ${item.tipo    ? `<span><strong>üé¨</strong> ${item.tipo}</span>`       : ''}
    `;
    document.getElementById('detailMeta').style.display = 'flex';
    document.getElementById('detailSynopsis').textContent = item.sinopse || 'Sinopse n√£o dispon√≠vel.';
    document.getElementById('detailSynopsis').style.display = '';
    document.getElementById('detailButtons').style.display = 'flex';

    document.getElementById('watchNowBtn').addEventListener('click', () => {
      document.getElementById('seasonsSection').scrollIntoView({ behavior: 'smooth' });
    });

    // Trailer
    const trailerEmbed = getYoutubeEmbedUrl(item.trailer);
    if (trailerEmbed) {
      document.getElementById('trailerFrame').src = trailerEmbed;
      document.getElementById('trailerSection').style.display = 'block';
    }

    // Cast
    renderCast(item.nomeElenco, item.fotoElenco);

    // Player
    document.getElementById('playerSection').style.display = 'block';
    document.getElementById('playerTitle').textContent = item.nome;

    seriePlayer = PipocaPlayer.initSeriePlayer({
      videoId:      'video',
      overlayId:    'playerOverlay',
      centerPlayId: 'centerPlay',
      controlsId:   'playerControls',
      playerBoxId:  'playerBox',
      titleId:      'playerTitle'
    });

    // Busca epis√≥dios
    temporadasData = await PipocaAPI.getEpisodiosPorSerie(item.nome);

    // Mostra se√ß√£o temporadas
    document.getElementById('seasonsSection').style.display = 'block';
    temporadaAtual = Math.min(...Object.keys(temporadasData).map(Number)) || 1;
    renderTemporadas(item.nome);

    // SEO
    document.querySelector('meta[name="description"]').content =
      `Assista ${item.nome} (${item.ano || ''}) online gr√°tis no PipocaFlix. ${(item.sinopse || '').slice(0, 120)}`;

  } catch (err) {
    console.error('[PipocaFlix S√©rie] Erro:', err);
    document.getElementById('loadingIndicator').textContent = '‚ö†Ô∏è Erro ao carregar a s√©rie.';
  }
}

/* ‚îÄ‚îÄ Search setup ‚îÄ‚îÄ */
function setupSearch(allItems) {
  const desktopInput    = document.getElementById('desktopSearchInput');
  const mobileInput     = document.getElementById('mobileSearchInput');
  const resultsOverlay  = document.getElementById('searchResultsOverlay');
  const resultsGrid     = document.getElementById('searchResultsGrid');
  const queryLabel      = document.getElementById('searchQueryLabel');

  function doSearch(q) {
    if (!q || q.length < 2) { resultsOverlay.classList.remove('active'); return; }
    const res = PipocaSearch.search(q, 24);
    queryLabel.textContent = `"${q}"`;
    resultsGrid.innerHTML  = '';
    res.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      const page = item.isSerie ? 'serie.html' : 'filme.html';
      card.innerHTML = `
        <img class="card-thumb" src="${item.capa||''}" alt="${item.nome}" loading="lazy"
          onerror="this.src='https://placehold.co/300x450/181818/555?text=Sem+Capa'">
        <span class="card-type-badge">${item.isSerie ? 'S√©rie' : 'Filme'}</span>
        <div class="card-play-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
        <div class="card-info">
          <div class="card-title">${item.nome}</div>
          <div class="card-meta"><span>${item.ano||''}</span></div>
        </div>`;
      card.addEventListener('click', () => { location.href = `${page}?nome=${encodeURIComponent(item.nome)}`; });
      resultsGrid.appendChild(card);
    });
    resultsOverlay.classList.add('active');
  }

  const deb = PipocaSearch.debounce(doSearch, 280);
  desktopInput.addEventListener('input', e => deb(e.target.value));
  mobileInput.addEventListener('input',  e => deb(e.target.value));
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      resultsOverlay.classList.remove('active');
      desktopInput.value = '';
      mobileInput.value  = '';
    }
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
