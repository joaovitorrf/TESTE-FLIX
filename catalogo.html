<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CatÃ¡logo â€” PipocaFlix</title>
<meta name="description" content="CatÃ¡logo completo de filmes e sÃ©ries no PipocaFlix.">
<meta name="theme-color" content="#ff2d43">
<link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>

<!-- Mobile search overlay -->
<div class="mobile-search-overlay" id="mobileSearchOverlay" role="dialog">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;color:var(--red)">
    <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
  </svg>
  <input type="search" class="mobile-search-input" id="mobileSearchInput"
    placeholder="Buscar..." autocomplete="off" spellcheck="false">
  <button class="mobile-search-cancel" id="mobileSearchClose">Cancelar</button>
</div>

<!-- Header -->
<header class="header" id="mainHeader">
  <a href="index.html" class="logo">PipocaFlix</a>
  <nav class="nav">
    <a href="index.html">InÃ­cio</a>
    <a href="catalogo.html" class="active">CatÃ¡logo</a>
    <a href="catalogo.html?tipo=filmes">Filmes</a>
    <a href="catalogo.html?tipo=series">SÃ©ries</a>
  </nav>
  <div class="search-wrapper">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
    <input type="search" class="search-bar" id="desktopSearchInput"
      placeholder="Buscar..." autocomplete="off" spellcheck="false">
  </div>
  <button class="search-toggle-btn" id="mobileSearchToggle" aria-label="Abrir busca" aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
  </button>
</header>

<!-- Search results -->
<div class="search-results-overlay" id="searchResultsOverlay">
  <p class="search-results-label">Resultados para: <strong id="searchQueryLabel"></strong></p>
  <div class="cards-grid" id="searchResultsGrid"></div>
</div>

<!-- Categoria ou tÃ­tulo dinÃ¢mico -->
<div class="cat-page-header" id="catPageHeader">
  <div class="cat-page-icon" id="catPageIcon">ğŸ¬</div>
  <div>
    <h1 class="cat-page-title" id="catPageTitle">CatÃ¡logo Completo</h1>
    <p class="cat-page-count" id="catPageCount">Carregando...</p>
  </div>
</div>

<!-- Ad 468x60 -->

<!-- Filtros rÃ¡pidos de tipo -->
<div style="padding: 1.25rem clamp(1rem,5vw,3.5rem) 0;display:flex;gap:0.5rem;flex-wrap:wrap" id="typeFilters">
  <button class="season-tab active" data-tipo="todos">Todos</button>
  <button class="season-tab" data-tipo="filmes">Filmes</button>
  <button class="season-tab" data-tipo="series">SÃ©ries</button>
</div>

<!-- Layout com sidebar -->
<div class="content-with-sidebar" style="padding: 1.25rem clamp(1rem,5vw,3.5rem) 2rem">

  <!-- Main content -->
  <div class="content-main">
    <!-- Skeleton -->
    <div class="cards-grid" id="skeletonGrid">
      <div class="skeleton"></div><div class="skeleton"></div>
      <div class="skeleton"></div><div class="skeleton"></div>
      <div class="skeleton"></div><div class="skeleton"></div>
      <div class="skeleton"></div><div class="skeleton"></div>
      <div class="skeleton"></div><div class="skeleton"></div>
    </div>

    <!-- Cards -->
    <div class="cards-grid" id="catalogoGrid" style="display:none"></div>

    <!-- Ad entre pÃ¡ginas -->
    

    <!-- PaginaÃ§Ã£o -->
    <nav class="pagination" id="pagination" aria-label="PaginaÃ§Ã£o"></nav>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <div class="footer-logo">PipocaFlix</div>
  <p class="footer-desc">O melhor catÃ¡logo de filmes e sÃ©ries online.</p>
  <div class="footer-bottom">
    <span>Â© 2025 PipocaFlix.</span>
    <a href="index.html" style="color:var(--red)">â† Voltar ao inÃ­cio</a>
  </div>
</footer>

<button class="back-to-top" id="backToTop" aria-label="Voltar ao topo">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>
</button>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script src="../assets/js/security.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/search.js"></script>
<script>
const PER_PAGE = 10;
let allContent = [], filtered = [], currentPage = 1;

// â”€â”€ Header scroll + back to top â”€â”€
window.addEventListener('scroll', () => {
  document.getElementById('mainHeader').classList.toggle('scrolled', window.scrollY > 60);
  document.getElementById('backToTop').classList.toggle('visible', window.scrollY > 400);
}, {passive:true});
document.getElementById('backToTop').addEventListener('click', () => window.scrollTo({top:0,behavior:'smooth'}));

// â”€â”€ Mobile search â”€â”€
document.getElementById('mobileSearchToggle').addEventListener('click', () => {
  document.getElementById('mobileSearchOverlay').classList.add('open');
  setTimeout(() => document.getElementById('mobileSearchInput').focus(), 80);
});
document.getElementById('mobileSearchClose').addEventListener('click', () => {
  document.getElementById('mobileSearchOverlay').classList.remove('open');
  document.getElementById('searchResultsOverlay').classList.remove('active');
  document.getElementById('mobileSearchInput').value = '';
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('mobileSearchOverlay').classList.remove('open');
    document.getElementById('searchResultsOverlay').classList.remove('active');
    document.getElementById('desktopSearchInput').value = '';
    document.getElementById('mobileSearchInput').value = '';
  }
});

// â”€â”€ Params â”€â”€
function getParam(k) { return new URLSearchParams(location.search).get(k); }

// â”€â”€ Card â”€â”€
function mkCard(item) {
  const div = document.createElement('div');
  div.className = 'card';
  const page = item.isSerie ? 'serie.html' : 'filme.html';
  div.innerHTML = `
    <div class="card-thumb-wrap">
      <img class="card-thumb" src="${item.capa||''}" alt="${item.nome}" loading="lazy"
        onerror="this.src='https://placehold.co/300x450/13131a/333?text=Sem+Capa'">
      <span class="card-badge">${item.isSerie?'SÃ©rie':'Filme'}</span>
      <div class="card-play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
    </div>
    <div class="card-info">
      <div class="card-name">${item.nome}</div>
      <div class="card-meta-row">
        ${item.ano?`<span>${item.ano}`:''}
        ${item.categoria?`<span>Â· ${item.categoria.split(',')[0].trim()}</span>`:''}
      </div>
    </div>`;
  div.addEventListener('click', () => { location.href=`${page}?nome=${encodeURIComponent(item.nome)}`; });
  div.setAttribute('role','button'); div.setAttribute('tabindex','0');
  div.addEventListener('keydown', e => { if(e.key==='Enter'||e.key===' ') div.click(); });
  return div;
}

// â”€â”€ Render page â”€â”€
function renderPage() {
  const grid    = document.getElementById('catalogoGrid');
  const skeleton= document.getElementById('skeletonGrid');
  skeleton.style.display = 'none';
  grid.style.display     = 'grid';
  

  const start = (currentPage-1)*PER_PAGE;
  const slice = filtered.slice(start, start+PER_PAGE);

  grid.innerHTML = '';
  if (slice.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1;color:var(--text-3);text-align:center;padding:4rem 0">Nenhum conteÃºdo encontrado.</p>';
  } else {
    slice.forEach(item => grid.appendChild(mkCard(item)));
  }

  document.getElementById('catPageCount').textContent =
    `${filtered.length} tÃ­tulos Â· PÃ¡gina ${currentPage} de ${Math.ceil(filtered.length/PER_PAGE)||1}`;

  renderPagination();
  window.scrollTo({top: document.getElementById('catPageHeader').offsetTop - 80, behavior:'smooth'});
}

// â”€â”€ Pagination â”€â”€
function renderPagination() {
  const total = Math.ceil(filtered.length/PER_PAGE);
  const nav   = document.getElementById('pagination');
  nav.innerHTML = '';
  if (total <= 1) return;

  function mkBtn(label, page, disabled, active) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (active?' active':'');
    btn.textContent = label;
    btn.disabled = disabled;
    if (active) btn.setAttribute('aria-current','page');
    btn.addEventListener('click', () => { currentPage=page; renderPage(); });
    return btn;
  }
  function mkEllipsis() {
    const s = document.createElement('span');
    s.className='page-ellipsis'; s.textContent='â€¦';
    return s;
  }

  nav.appendChild(mkBtn('â€¹', currentPage-1, currentPage===1, false));

  const start = Math.max(1, Math.min(currentPage-2, total-4));
  const end   = Math.min(total, start+4);

  if (start>1) { nav.appendChild(mkBtn('1',1,false,false)); if(start>2) nav.appendChild(mkEllipsis()); }
  for (let i=start;i<=end;i++) nav.appendChild(mkBtn(i,i,false,i===currentPage));
  if (end<total) { if(end<total-1) nav.appendChild(mkEllipsis()); nav.appendChild(mkBtn(total,total,false,false)); }

  nav.appendChild(mkBtn('â€º', currentPage+1, currentPage===total, false));
}

// â”€â”€ Apply filter â”€â”€
function applyFilter(tipo, cat) {
  if (tipo === 'filmes')  filtered = allContent.filter(c=>!c.isSerie);
  else if (tipo==='series') filtered = allContent.filter(c=>c.isSerie);
  else filtered = [...allContent];

  if (cat) {
    const normCat = cat.toLowerCase();
    filtered = filtered.filter(c => c.categoria && c.categoria.toLowerCase().includes(normCat));
  }

  currentPage = 1;
  renderPage();
}

// â”€â”€ Type filter buttons â”€â”€
function setupTypeFilters(tipo) {
  document.querySelectorAll('[data-tipo]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tipo === (tipo||'todos'));
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-tipo]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const cat = getParam('cat');
      applyFilter(btn.dataset.tipo, cat);
    });
  });
}

// â”€â”€ Search â”€â”€
function setupSearch(allItems) {
  PipocaSearch.indexContent(allItems);
  const resultsOverlay = document.getElementById('searchResultsOverlay');
  const resultsGrid    = document.getElementById('searchResultsGrid');
  const queryLabel     = document.getElementById('searchQueryLabel');
  function doSearch(q) {
    if (!q||q.length<2) { resultsOverlay.classList.remove('active'); return; }
    const res = PipocaSearch.search(q, 30);
    queryLabel.textContent = q;
    resultsGrid.innerHTML  = '';
    res.forEach(item => resultsGrid.appendChild(mkCard(item)));
    resultsOverlay.classList.add('active');
  }
  const deb = PipocaSearch.debounce(doSearch, 250);
  document.getElementById('desktopSearchInput').addEventListener('input', e=>deb(e.target.value));
  document.getElementById('mobileSearchInput').addEventListener('input', e=>deb(e.target.value));
}

// â”€â”€ Page header by cat/tipo â”€â”€
const CAT_EMOJIS = {
  'aÃ§Ã£o':'âš¡','acao':'âš¡','romance':'ğŸ’•','terror':'ğŸ‘»','horror':'ğŸ‘»','comÃ©dia':'ğŸ˜‚','comedia':'ğŸ˜‚',
  'drama':'ğŸ­','ficÃ§Ã£o':'ğŸš€','ficcao':'ğŸš€','animaÃ§Ã£o':'âœ¨','animacao':'âœ¨','aventura':'ğŸ—ºï¸',
  'thriller':'ğŸ”ª','crime':'ğŸ”«','fantasia':'ğŸ§™','documentÃ¡rio':'ğŸ“½ï¸','documentario':'ğŸ“½ï¸'
};
function getEmoji(cat) {
  if (!cat) return 'ğŸ¬';
  const k = cat.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  for (const [key,val] of Object.entries(CAT_EMOJIS)) { if (k.includes(key)) return val; }
  return 'ğŸ¬';
}

// â”€â”€ INIT â”€â”€
async function init() {
  const tipo = getParam('tipo') || 'todos';
  const cat  = getParam('cat');

  // Header dinÃ¢mico
  if (cat) {
    document.getElementById('catPageIcon').textContent = getEmoji(cat);
    document.getElementById('catPageTitle').textContent = cat;
    document.title = `${cat} â€” PipocaFlix`;
  } else if (tipo === 'filmes') {
    document.getElementById('catPageIcon').textContent = 'ğŸ¬';
    document.getElementById('catPageTitle').textContent = 'Filmes';
    document.title = 'Filmes â€” PipocaFlix';
  } else if (tipo === 'series') {
    document.getElementById('catPageIcon').textContent = 'ğŸ“º';
    document.getElementById('catPageTitle').textContent = 'SÃ©ries';
    document.title = 'SÃ©ries â€” PipocaFlix';
  }

  setupTypeFilters(cat ? 'todos' : tipo);

  try {
    const [filmes, series] = await Promise.all([PipocaAPI.getFilmes(), PipocaAPI.getSeries()]);
    allContent = [...filmes, ...series];
    setupSearch(allContent);
    applyFilter(cat ? 'todos' : tipo, cat);
  } catch(err) {
    console.error('[PipocaFlix CatÃ¡logo]', err);
    document.getElementById('skeletonGrid').style.display='none';
    document.getElementById('catalogoGrid').style.display='grid';
    document.getElementById('catalogoGrid').innerHTML=
      '<p style="grid-column:1/-1;color:var(--text-3);text-align:center;padding:4rem 0">âš ï¸ Erro ao carregar. Tente novamente.</p>';
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
